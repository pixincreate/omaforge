#!/bin/bash
# Add packages to package lists declaratively

set -euo pipefail

OMAFORGE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PACKAGES_DIR="$OMAFORGE_PATH/packages"

show_usage() {
    echo "Usage: omaforge-add <package-type> <package-name>"
    echo ""
    echo "Package types:"
    echo "  brew              CLI packages (brew.packages)"
    echo "  cask              GUI applications (cask.packages)"
    echo "  rust              Rust tools (rust.packages)"
    echo ""
    echo "Examples:"
    echo "  omaforge-add brew neovim          # Add neovim to brew packages"
    echo "  omaforge-add cask firefox         # Add Firefox to cask packages"
    echo "  omaforge-add rust bat             # Add bat to rust packages"
    echo ""
    echo "After adding, run: ./macos-setup --only packaging/<type>"
}

# Validate arguments
if [[ $# -lt 2 ]]; then
    show_usage
    exit 1
fi

PACKAGE_TYPE="$1"
PACKAGE_NAME="$2"

case "$PACKAGE_TYPE" in
    brew)
        PACKAGE_FILE="$PACKAGES_DIR/brew.packages"
        ;;
    cask)
        PACKAGE_FILE="$PACKAGES_DIR/cask.packages"
        ;;
    rust)
        PACKAGE_FILE="$PACKAGES_DIR/rust.packages"
        ;;
    *)
        echo "Error: Unknown package type: $PACKAGE_TYPE"
        show_usage
        exit 1
        ;;
esac

# Check if package already exists
if grep -q "^$PACKAGE_NAME$" "$PACKAGE_FILE" 2>/dev/null; then
    echo "Package '$PACKAGE_NAME' already exists in $PACKAGE_TYPE"
    exit 0
fi

# Add package
echo "$PACKAGE_NAME" >> "$PACKAGE_FILE"
echo "âœ“ Added '$PACKAGE_NAME' to $PACKAGE_TYPE packages"
echo ""
echo "To install, run:"
echo "  ./macos-setup --only packaging/$PACKAGE_TYPE"

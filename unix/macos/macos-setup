#!/bin/bash
# macOS Declarative Setup System
# Main entry point

set -eEo pipefail

# Error handler
error_handler() {
    local line_no=$1
    echo ""
    echo "[ERROR] Setup failed at line $line_no"
    echo "[ERROR] Check the output above for details"
    exit 1
}

trap 'error_handler $LINENO' ERR

# Parse command-line arguments
ONLY_MODULE=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --only)
            ONLY_MODULE="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --only <module>    Run only a specific module"
            echo "                     Examples: config/git, packaging/homebrew"
            echo "  --help, -h        Show this help message"
            echo ""
            echo "Examples:"
            echo "  $0                          # Run full setup"
            echo "  $0 --only config/git        # Run only git configuration"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Define paths with OMAFORGE prefix for consistency
export OMAFORGE_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export OMAFORGE_INSTALL="$OMAFORGE_PATH/install"
export OMAFORGE_CONFIG="$OMAFORGE_PATH/config.json"
export PATH="$OMAFORGE_PATH/bin:$PATH"

# Ensure jq is available for JSON parsing
if ! command -v jq &>/dev/null; then
    echo "[INFO] jq is required for configuration parsing"
    echo "[INFO] Installing jq via Homebrew..."

    # Install Homebrew if needed
    if ! command -v brew &>/dev/null; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add to PATH
        if [[ -f /opt/homebrew/bin/brew ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [[ -f /usr/local/bin/brew ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
        fi
    fi

    brew install jq
    echo "[SUCCESS] jq installed"
fi

# Source all helper functions
source "$OMAFORGE_INSTALL/helpers/all.sh"

# Function to run a single module
run_single_module() {
    local module="$1"

    # Handle paths like "config/nextdns" or "dotfiles/stow"
    if [[ "$module" == */* ]]; then
        # It's a path - check if file exists directly
        local module_path="$OMAFORGE_INSTALL/$module"
        [[ "$module" != *.sh ]] && module_path="$module_path.sh"
        
        if [[ -f "$module_path" ]]; then
            echo "[INFO] Running: $module_path"
            source "$module_path"
            echo "[SUCCESS] Completed"
            return 0
        fi
    fi

    # Add .sh if not present
    [[ "$module" != *.sh ]] && module="$module.sh"

    # Find the module file
    local module_path=$(find "$OMAFORGE_INSTALL" -name "$module" -type f | head -1)

    if [[ -z "$module_path" ]]; then
        echo "[ERROR] Module not found: $module"
        exit 1
    fi

    echo "[INFO] Running: $module_path"
    source "$module_path"
    echo "[SUCCESS] Completed"
}

# Presentation helpers
show_logo() {
    clear
    cat << 'EOF'
 ▄██████▄    ▄▄▄▄███▄▄▄▄      ▄████████    ▄████████  ▄██████▄     ▄████████    ▄██████▄     ▄████████
███    ███ ▄██▀▀▀███▀▀▀██▄   ███    ███   ███    ███ ███    ███   ███    ███   ███    ███   ███    ███
███    ███ ███   ███   ███   ███    ███   ███    █▀  ███    ███   ███    ███   ███    █▀    ███    █▀
███    ███ ███   ███   ███   ███    ███  ▄███▄▄▄     ███    ███  ▄███▄▄▄▄██▀  ▄███         ▄███▄▄▄
███    ███ ███   ███   ███ ▀███████████ ▀▀███▀▀▀     ███    ███ ▀▀███▀▀▀▀▀   ▀▀███ ████▄  ▀▀███▀▀▀
███    ███ ███   ███   ███   ███    ███   ███        ███    ███ ▀███████████   ███    ███   ███    █▄
███    ███ ███   ███   ███   ███    ███   ███        ███    ███   ███    ███   ███    ███   ███    ███
 ▀██████▀   ▀█   ███   █▀    ███    █▀    ███         ▀██████▀    ███    ███   ████████▀    ██████████
                                                                   ███    ███
EOF
    echo ""
}

show_welcome() {
    show_logo
    echo "Declarative macOS Setup System"
    echo ""
    echo "This will configure your macOS system with:"
    echo "  - Homebrew package management"
    echo "  - Development tools and applications"
    echo "  - System configuration and optimizations"
    echo "  - Dotfiles and configurations"
    echo ""
}

# Check if running single module or full setup
if [[ -n "$ONLY_MODULE" ]]; then
    run_single_module "$ONLY_MODULE"
else
    # Show welcome message
    show_welcome

    # Execute installation phases
    source "$OMAFORGE_INSTALL/preflight/all.sh"
    source "$OMAFORGE_INSTALL/packaging/all.sh"
    source "$OMAFORGE_INSTALL/config/all.sh"
    source "$OMAFORGE_INSTALL/dotfiles/all.sh"
    source "$OMAFORGE_INSTALL/post-install/all.sh"
fi
